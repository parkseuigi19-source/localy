<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Mission Test Page</title>

  <style>
    body {
      font-family: 'Pretendard', Arial, sans-serif;
      background: #f8f9fc;
      padding: 30px;
      max-width: 900px;
      margin: 0 auto;
      color: #444;
    }

    h1 {
      text-align: center;
      color: #5a78ff;
      margin-bottom: 40px;
      font-size: 32px;
    }

    .card {
      background: white;
      padding: 25px;
      margin-bottom: 35px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(150, 170, 255, 0.2);
      transition: 0.3s;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(150, 170, 255, 0.25);
    }

    input, select, button {
      width: 100%;
      padding: 12px 14px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid #ddd;
      margin-top: 10px;
    }
    button {
      background: #7a8cff;
      color: white;
      border: none;
      margin-top: 15px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #6575e8;
    }

    .result-box {
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-line;
      transition: 0.3s;
    }

    .success-box {
      background: #d8f8e6;
      border: 2px solid #8be1b1;
      color: #18794e;
      animation: fadeUp 0.4s;
    }
    .fail-box {
      background: #ffe3e3;
      border: 2px solid #ff9b9b;
      color: #a82020;
      animation: fadeUp 0.4s;
    }
    .loading-box {
      background: #fff4d6;
      border: 2px solid #ffcf7a;
      color: #9e6a00;
      animation: fadeUp 0.4s;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
    .tag {
      display: inline-block;
      background: #e0e7ff;
      padding: 6px 12px;
      margin: 3px;
      border-radius: 20px;
      color: #4a56a6;
      font-size: 13px;
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      from { transform: scale(0.6); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
    .preview-box {
      margin-top: 15px;
      display: flex;
      gap: 12px;
    }
    .preview-box img {
      width: 45%;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

  </style>
</head>

<body>

<h1>ğŸ¯ ì—¬í–‰ ë¯¸ì…˜ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>

<!-- --------------------------
  1) ë¯¸ì…˜ ì—…ë¡œë“œ
--------------------------- -->
<div class="card">
  <h2>ğŸ“¤ 1ë‹¨ê³„: ë¯¸ì…˜ ì—…ë¡œë“œ</h2>

  <input type="file" id="uploadFile" accept="image/*">
  <div class="preview-box" id="originPreviewBox"></div>

  <input type="text" id="missionKind" value="landmark" placeholder="mission_kind (landmark / food / location)">
  <input type="text" id="uploadLat" value="37.55" placeholder="latitude">
  <input type="text" id="uploadLng" value="126.98" placeholder="longitude">
  
  <button onclick="uploadMission()">ğŸ“¤ ì—…ë¡œë“œ</button>

  <div id="uploadResult" class="result-box loading-box" style="display:none"></div>
</div>


<!-- --------------------------
  2) ìƒíƒœ í™•ì¸
--------------------------- -->
<div class="card">
  <h2>ğŸ“¡ 2ë‹¨ê³„: ë¯¸ì…˜ ìƒíƒœ í™•ì¸</h2>

  <input type="text" id="statusMissionId" placeholder="mission_id (ìë™ ì…ë ¥ë¨)" readonly>
  <button onclick="checkStatus()">ğŸ“¡ ìƒíƒœ í™•ì¸</button>

  <div id="statusResult" class="result-box loading-box" style="display:none"></div>
</div>


<!-- --------------------------
  3) ë¯¸ì…˜ ì²´í¬
--------------------------- -->
<div class="card">
  <h2>ğŸ¯ 3ë‹¨ê³„: ë¯¸ì…˜ ìˆ˜í–‰ ì²´í¬</h2>

  <input type="text" id="checkMissionId" placeholder="mission_id (ìë™ ì…ë ¥ë¨)" readonly>

  <input type="file" id="checkFile" accept="image/*">
  <div class="preview-box" id="checkPreviewBox"></div>

  <input type="text" id="checkLat" value="37.55" placeholder="latitude">
  <input type="text" id="checkLng" value="126.98" placeholder="longitude">

  <button onclick="checkMission()">ğŸ¯ ì²´í¬í•˜ê¸°</button>

  <div id="checkResult" class="result-box success-box" style="display:none"></div>
</div>

<script>
const BASE = "http://127.0.0.1:8002";

/* --------------------------
  ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
--------------------------- */
function previewImage(input, previewBoxId) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById(previewBoxId).innerHTML =
      `<img src="${e.target.result}">`;
  };
  reader.readAsDataURL(file);
}

document.getElementById("uploadFile").addEventListener("change", function () {
  previewImage(this, "originPreviewBox");
});
document.getElementById("checkFile").addEventListener("change", function () {
  previewImage(this, "checkPreviewBox");
});


/* --------------------------
  1) ë¯¸ì…˜ ì—…ë¡œë“œ
--------------------------- */
async function uploadMission() {
  const file = uploadFile.files[0];
  if (!file) return alert("ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”!");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("mission_kind", missionKind.value);
  fd.append("latitude", uploadLat.value);
  fd.append("longitude", uploadLng.value);

  uploadResult.style.display = "block";
  uploadResult.className = "result-box loading-box";
  uploadResult.textContent = "â³ ì—…ë¡œë“œ ì¤‘...";

  const res = await fetch(`${BASE}/upload`, {
    method: "POST",
    body: fd
  });
  const data = await res.json();

  statusMissionId.value = data.mission_id;
  checkMissionId.value = data.mission_id;

  uploadResult.className = "result-box success-box";
  uploadResult.textContent = "ğŸ“¤ ì—…ë¡œë“œ ì„±ê³µ!\n\n" + JSON.stringify(data, null, 2);
}


/* --------------------------
  2) ìƒíƒœ í™•ì¸
--------------------------- */
async function checkStatus() {
  const id = statusMissionId.value;
  statusResult.style.display = "block";
  statusResult.className = "result-box loading-box";
  statusResult.textContent = "â³ ìƒíƒœ í™•ì¸ ì¤‘...";

  const res = await fetch(`${BASE}/status/${id}`);
  const data = await res.json();

  statusResult.className =
    data.status === "done" ? "result-box success-box" : "result-box loading-box";

  statusResult.textContent = `ìƒíƒœ: ${data.status}\n\n${JSON.stringify(data, null, 2)}`;
}


/* --------------------------
  3) ë¯¸ì…˜ ì²´í¬
--------------------------- */
async function checkMission() {
  const id = checkMissionId.value;
  const file = checkFile.files[0];

  const fd = new FormData();
  fd.append("mission_id", id);
  fd.append("file", file);
  fd.append("latitude", checkLat.value);
  fd.append("longitude", checkLng.value);

  checkResult.style.display = "block";
  checkResult.className = "result-box loading-box";
  checkResult.textContent = "â³ ì²´í¬ ì¤‘...";

  const res = await fetch(`${BASE}/mission/check`, {
    method: "POST",
    body: fd
  });
  const data = await res.json();

  // ì„±ê³µ/ì‹¤íŒ¨ ë°°ê²½ ë°”ê¾¸ê¸°
  checkResult.className = data.success
    ? "result-box success-box"
    : "result-box fail-box";

  // íƒœê·¸ UI ìƒì„±
  let tags = "";
  if (data.detected_objects) {
    data.detected_objects.forEach(obj => {
      tags += `<span class="tag"># ${obj}</span>`;
    });
  }

  checkResult.innerHTML = `
${data.success ? "ğŸ‰ ë¯¸ì…˜ ì„±ê³µ!" : "âŒ ë¯¸ì…˜ ì‹¤íŒ¨..."} 

ğŸ“ GPS OK : ${data.gps_ok}
ê±°ë¦¬ : ${data.distance_m}m

ğŸ–¼ï¸ ìœ ì‚¬ë„ : ${data.similarity}%  

ğŸ” ê°ì§€ëœ ê°ì²´  
${tags || "ì—†ìŒ"}

-----------------------------------
ì „ì²´ ì‘ë‹µ
${JSON.stringify(data, null, 2)}
`;
}

</script>

</body>
</html>
